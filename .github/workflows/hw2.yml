name: HW2 - Deploy Infrastructure and Configure with Ansible

on:
  workflow_dispatch:

env:
    SIEGE_IP: ${{ secrets.SIEGE_IP }}
    WEB_IP: ${{ secrets.WEB_IP }}
    SQL_IP: ${{ secrets.SQL_IP }}
    AWS_REGION: ap-southeast-2

jobs:
  ansible:
    name: Configure Servers with Ansible
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible pymysql

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/ansibleSSH.pem
          chmod 600 ~/.ssh/ansibleSSH.pem
          
      - name: Test SSH Connectivity
        run: |
          ssh -i ~/.ssh/ansibleSSH.pem -o StrictHostKeyChecking=no -o ConnectTimeout=5 ec2-user@${{ secrets.SIEGE_IP }} "echo 'Siege server connected'" || echo "Siege connection failed"
          ssh -i ~/.ssh/ansibleSSH.pem -o StrictHostKeyChecking=no -o ConnectTimeout=5 ec2-user@${{ secrets.WEB_IP }} "echo 'Web server connected'" || echo "Web connection failed"
          ssh -i ~/.ssh/ansibleSSH.pem -o StrictHostKeyChecking=no -o ConnectTimeout=5 ec2-user@${{ secrets.SQL_IP }} "echo 'SQL server connected'" || echo "SQL connection failed"

      - name: Generate Ansible Inventory
        run: |
          cat > HW2/ansible/inventories/production/hosts.ini << EOF
          [siege]
          siege1 ansible_ssh_host=${{ secrets.SIEGE_IP }}

          [web]
          web1 ansible_ssh_host=${{ secrets.WEB_IP }}

          [sql]
          sql1 ansible_ssh_host=${{ secrets.SQL_IP }}
          EOF

      - name: Display Inventory
        run: cat HW2/ansible/inventories/production/hosts.ini

      - name: Run Ansible Playbook
        working-directory: HW2/ansible
        run: |
          ansible-playbook -i inventories/production/hosts.ini site.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"

      - name: Display Server Information
        run: |
          echo "=== Deployment Complete ==="
          echo "Siege Server: ${{ secrets.SIEGE_IP }}"
          echo "Web Server: http://${{ secrets.WEB_IP }}"
          echo "SQL Server: ${{ secrets.SQL_IP }}"
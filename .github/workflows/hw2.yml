name: HW2 - Deploy Infrastructure and Configure with Ansible

on:
  workflow_dispatch:
    inputs: 
      siege_ip:
        description: 'Siege Server IP Address'
        required: true
      web_ip:
        description: 'Web Server IP Address'
        required: true
      sql_ip:
        description: 'SQL Server IP Address'
        required: true

env:
    SIEGE_IP: ${{ inputs.siege_ip }}
    WEB_IP: ${{ inputs.web_ip }}
    SQL_IP: ${{ inputs.sql_ip }}
    AWS_REGION: ap-southeast-2

jobs:
  ansible:
    name: Configure Servers with Ansible
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible pymysql

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BALLY }}" > ~/.ssh/ansibleSSH.pem
          chmod 600 ~/.ssh/ansibleSSH.pem

      - name: Generate Ansible Inventory
        run: |
          cat > HW2/ansible/inventories/production/hosts.ini << EOF
          [siege]
          siege1 ansible_ssh_host=${{ env.SIEGE_IP }}

          [web]
          web1 ansible_ssh_host=${{ env.WEB_IP }}

          [sql]
          sql1 ansible_ssh_host=${{ env.SQL_IP }}
          EOF

      - name: Display Inventory
        run: cat HW2/ansible/inventories/production/hosts.ini

      - name: Run Ansible Playbook
        working-directory: HW2/ansible
        run: |
          ansible-playbook -i inventories/production/hosts.ini site.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"

      - name: Display Server Information
        run: |
          echo "=== Deployment Complete ==="
          echo "Siege Server: ${{ env.SIEGE_IP }}"
          echo "Web Server: http://${{ env.WEB_IP }}"
          echo "SQL Server: ${{ env.SQL_IP }}"
name: HW3 - Deploy Infrastructure and Configure with Ansible

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment Type'
        required: true
        type: choice
        options:
          - PaaS
          - IaaS
      sql_ip:
        description: 'SQL Server IP Address'
        required: true
      

env:
    DEPLOYMENT_TYPE: ${{ inputs.deployment_type }}
    SQL_IP: ${{ inputs.sql_ip }}
    AWS_REGION: ap-southeast-2

jobs:
  ansible:
    name: Configure Servers with Ansible (PaaS)
    runs-on: ubuntu-latest
    if: ${{ inputs.deployment_type == 'PaaS' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible pymysql

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BALLY }}" > ~/.ssh/ansibleSSH.pem
          chmod 600 ~/.ssh/ansibleSSH.pem

      - name: Generate Ansible Inventory
        run: |
          cat > HW3/ansible/inventories/hosts.ini << EOF
          [sql]
          sql1 ansible_ssh_host=${{ env.SQL_IP }}
          EOF

      - name: Display Inventory
        run: cat HW3/ansible/inventories/hosts.ini

      - name: Run Ansible Playbook
        working-directory: HW3/ansible
        run: |
          ansible-playbook -i inventories/hosts.ini site.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"

      - name: Display Server Information
        run: |
          echo "=== Deployment Complete ==="
          echo "SQL Server: ${{ env.SQL_IP }}"